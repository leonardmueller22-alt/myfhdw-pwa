<!DOCTYPE HTML>
<html lang="de">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Abgaben</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#21376a">
    <link rel="apple-touch-icon" href="img/homescreen192.png">
    
    <link rel="stylesheet" href="https://d2q8mlawr49whx.cloudfront.net/V18.05.5/styles/style.css" type="text/css"/>
    <link rel="stylesheet" href="https://d2q8mlawr49whx.cloudfront.net/V18.05.5/styles/vorlage.css" type="text/css"/>
    <link rel="stylesheet" href="https://d2q8mlawr49whx.cloudfront.net/V18.05.5/jscripts/fontawesome/css/all.min.css" type="text/css"/>
    <link rel="stylesheet" href="https://d2q8mlawr49whx.cloudfront.net/V18.05.5/jscripts/bootstrap/css/bootstrap.min.css" type="text/css"/>
    <link rel="stylesheet" href="https://d2q8mlawr49whx.cloudfront.net/V18.05.5/jscripts/bootstrap/css/bootstrap.custom.css" type="text/css"/>
    <link rel="stylesheet" href="https://d2q8mlawr49whx.cloudfront.net/V18.05.5/styles/buttons.css" type="text/css"/>
    <link rel="stylesheet" href="https://d2q8mlawr49whx.cloudfront.net/V18.05.5/styles/content.css" type="text/css"/>
    <link rel="stylesheet" href="styles/custom.css" type="text/css" media="all"/>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon"/>
    
    <style>
        .navbar-nav > li > a { line-height: 20px !important; }
        .navbar { min-height: 50px !important; border: 1px solid transparent; margin-bottom: 20px; }
        .feedback-container { background-color: #fff; padding: 30px; border: 1px solid #ddd; text-align: center; border-top: 3px solid #21376a; margin-top: 20px; }
        .star-rating { font-size: 40px; color: #ddd; cursor: pointer; margin-bottom: 20px; }
        .star-rating .fa-star.checked, .star-rating .fa-star.hover { color: #f39200; }
        textarea.form-control { resize: none; border-radius: 0; box-shadow: none; border-color: #ccc; }
        .btn-submit { margin-top: 20px; width: 100%; font-weight: bold; padding: 10px; background-color: #21376a; border-color: #21376a; color: #fff; }
        .btn-submit:hover { background-color: #1a2b55; color: #fff; }
        .btn-submit:disabled { background-color: #eee; border-color: #ddd; color: #999; cursor: not-allowed; }
    </style>
    
    <script type="text/javascript" src="https://d2q8mlawr49whx.cloudfront.net/V18.05.5/js/jquery/js/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="https://d2q8mlawr49whx.cloudfront.net/V18.05.5/jscripts/bootstrap/js/bootstrap.min.js"></script>
</head>
<body id="community-facelift">
    <div id="container-spacer">
        <div class="community-facelift header-logo-box">
            <div class="container" style="overflow: hidden;">
                <a title="Home" href="dashboard.html">
                    <img src="img/Community_Banner.jpg" class="img-responsive" alt="page logo"/>
                </a>
            </div>
        </div>
        <nav role="navigation" id="top-navigation" class="navbar navbar-default community-facelift">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-id">
                        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
                    </button>
                    <a href="dashboard.html" class="navbar-brand"><span class="glyphicon glyphicon-home"></span></a>
                </div>
                <div class="collapse navbar-collapse" id="navbar-collapse-id">
                    <ul class="nav navbar-nav">
                        <li><a href="profile.html">Mein Profil</a></li>
                        <li><a href="timetable.html">Stundenplan</a></li>
                        <li><a href="pruefungstermine.html">Prüfungstermine</a></li>
                        <li><a href="notenuebersicht.html">Notenübersicht</a></li>
                        <li><a href="dokumente.html">Dokumente</a></li>
                        <li class="active"><a href="abgaben.html">Abgaben</a></li>
                        <li><a href="kurzbewerbung.html">Kurzbewerbung Master-Studium</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="container">
            <div class="row">
                <div class="col-md-8 col-md-offset-2">
                    <div class="feedback-container">
                        <h2 class="feedback-title">Wir würden uns über eine Bewertung freuen</h2>
                        <div class="star-rating" id="starRating">
                            <span class="fa fa-star" data-value="1"></span><span class="fa fa-star" data-value="2"></span>
                            <span class="fa fa-star" data-value="3"></span><span class="fa fa-star" data-value="4"></span>
                            <span class="fa fa-star" data-value="5"></span>
                        </div>
                        <form id="feedbackForm" onsubmit="return false;">
                            <textarea class="form-control" rows="4" placeholder="Kommentar..." id="feedbackText"></textarea>
                            <button id="submitBtn" type="button" class="btn btn-submit" disabled>Abschicken</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Service Worker Registrierung (identisch zum Dashboard)
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function() {
                    navigator.serviceWorker.register('sw.js');
                });
            }

            var currentRating = 0;

            // Sterne-Logik
            $('.star-rating .fa-star').on('click', function() {
                currentRating = $(this).data('value');
                $('.star-rating .fa-star').each(function() {
                    $(this).toggleClass('checked', $(this).data('value') <= currentRating);
                });
                $('#submitBtn').prop('disabled', false);
            });

            // Klick-Handler mit "Dashboard-Logik"
            $('#submitBtn').on('click', function(e) {
                e.preventDefault();
                var btn = $(this);

                // Funktion zum Senden
                function doSendNotification() {
                    if ('serviceWorker' in navigator) {
                        // WICHTIG: getRegistration statt ready nutzen (wie im Dashboard)
                        navigator.serviceWorker.getRegistration().then(function(reg) {
                            var options = {
                                body: 'Vielen Dank für deine ' + currentRating + ' Sterne!',
                                icon: 'img/homescreen192.png',
                                vibrate: [100, 50, 100], // Vibration wieder an, da es beim Login klappt
                                tag: 'feedback-' + Date.now()
                            };

                            if (reg) {
                                // Versuche es über den Service Worker
                                reg.showNotification('Bewertung erfolgreich!', options)
                                    .then(function() {
                                        btn.text("Gesendet!").prop('disabled', true);
                                    })
                                    .catch(function(err) {
                                        // Falls SW fehlschlägt, Alert
                                        alert("Fehler beim Senden: " + err);
                                    });
                            } else {
                                // Fallback: Normale Notification (falls SW nicht greift)
                                try {
                                    new Notification('Bewertung erfolgreich!', options);
                                    btn.text("Gesendet!").prop('disabled', true);
                                } catch (err) {
                                    alert("Service Worker nicht gefunden und Fallback fehlgeschlagen.");
                                }
                            }
                        });
                    }
                }

                // Berechtigungs-Prüfung
                if (Notification.permission === "granted") {
                    doSendNotification();
                } else if (Notification.permission !== "denied") {
                    Notification.requestPermission().then(function(permission) {
                        if (permission === "granted") {
                            doSendNotification();
                        } else {
                            alert("Benachrichtigungen wurden nicht erlaubt.");
                        }
                    });
                } else {
                    alert("Benachrichtigungen sind blockiert.");
                }
            });
        });
    </script>
</body>
</html>
